<script>
  var set_stars = function(form_id,answer_id) {
    var elem = $('#' + form_id + '_' + answer_id)
    if (elem.hasClass('on')) {
      elem.removeClass('on');
    }
    else {
      elem.addClass('on');
    }
  }  

  $(function() {
    $('.rating_star').click(function() {
      var form_id = $(this).attr('data-form-id');
      var answer_id = $(this).attr('data-answer-id');
      set_stars(form_id,answer_id);
      stars = 0;
        
      $('#' + form_id + '_stars').val(stars);
        
      $.ajax({
        type: "post",
        url: $('#' + form_id).attr('action'),
        data: $('#' + form_id).serialize()
      });
    });
  });
</script>

<h3>Domande su: <%= @question.property.titolo %></h3>

<p>
<strong>Utente:</strong>
<% if @question.user.provider != nil %>
  <%= @question.user.name %>
<% else %>
  <%= @question.user.username %>
<% end %>
</p>
<p>
<strong>Testo:</strong>
<%= @question.body %>
</p>

<%= link_to 'Indietro', property_path(@property) %>

<hr><h2>Risposte</h2>
<% @question.answers.each do |answer| %>
  <p>
    <strong>• </strong>
    <% if current_user.provider == nil %>
        <%= answer.user.username %>
    <% else %>
        <%= answer.user.name %>
    <% end %>
    <br>
    <strong>- </strong><%= answer.body %>
    <% if answer.user != current_user %>
      <ul class='rating'>
        <% form_id = "answer_#{answer.id}_rating" %>
          <%= form_for answer.answer_rating.last || answer.answer_rating.build, :html => {:id => "answer_#{answer.id}_rating" } do |f| %>
            <%= f.hidden_field :answer_id %>
          <% end %>
        
          <% answer.answer_rating.each do |r| %>
            <% current_answer = current_user.answer_rating.find_by(:id => r.id) %>
            <% if current_answer %>
              <% if current_answer.stars == 1 %>
                <li class="rating_star on" data-answer-id = "<%= answer.id %>" data-form-id = "<%= form_id %>" id= "<%= "#{form_id}_#{answer.id}" %>"></li>
                &nbsp;&nbsp;<i>Clicca per rimuovere un voto<i>
                <% break %>
              <% else %>
                <li class="rating_star" data-answer-id = "<%= answer.id %>" data-form-id = "<%= form_id %>" id= "<%= "#{form_id}_#{answer.id}" %>"></li>
                &nbsp;&nbsp;<i>Clicca per aggiungere un voto<i>
                <% break %>
              <% end %>
            <% else %>
              <li class="rating_star" data-answer-id = "<%= answer.id %>" data-form-id = "<%= form_id %>" id= "<%= "#{form_id}_#{answer.id}" %>"></li>
              &nbsp;&nbsp;<i>Clicca per aggiungere un voto<i>
            <% end %>
          <% end %>
      </ul><br>
    <% end %>
    Valutazione: <%= answer.valutation %>
    <% if current_user == @question.user || current_user == answer.user %>
      <%= link_to 'Elimina', [answer.question.property, answer.question, answer],
               method: :delete,
               data: { confirm: 'Sei sicuro?' } %>
    <% end %>
  </p>
<% end %>

<% if current_user != nil %>
  <h2>Aggiungi una risposta:</h2>
  <%= form_for([@property, @question, @question.answers.build]) do |f| %>
    <p>
      <%= f.text_area :body %>
    </p>
    <p>
      <%= f.submit "Invia" %>
    </p>
  <% end %>
<% end %>
